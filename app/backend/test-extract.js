// Test with EXACT user-provided content

const rawContent = String.raw`\section*{Solutions}
1. (B)
$\lim _ { n \rightarrow \infty } \left( \frac { 1 } { 1 + n } + \ldots + \frac { 1 } { n + n } \right) = \lim _ { n \rightarrow \infty } \sum _ { r = 1 } ^ { n } \frac { 1 } { n + r }$
$= \lim _ { n \rightarrow \infty } \sum _ { r = 1 } ^ { n } \frac { 1 } { n } \left( \frac { 1 } { 1 + \frac { r } { n } } \right)$
$= \int _ { 0 } ^ { 1 } \frac { 1 } { 1 + x } d x = [ \ln ( 1 + x ) ] _ { 0 } ^ { 1 } = \ln 2$
2. (A)
$\begin{aligned}
& \sim ( q \vee ( ( \sim q ) \wedge p ) ) \\
& = \sim q \wedge \sim ( ( \sim q ) \wedge p ) \\
& \quad = \sim q \wedge ( q \vee \sim p ) \\
& = ( \sim q \wedge q ) \vee ( \sim q \wedge \sim p ) \\
& \quad = ( \sim q \wedge \sim p )
\end{aligned}$
3. (B)
$n p + n p q = 5 , n p \cdot n p q = 6$
4. (B)
Some content
5. (B)
Some content
6. (D)
![](https://cdn.mathpix.com/cropped/e9b73bf5-0740-4f61-9d85-6f61a0d7a615-03.jpg?height=469&width=964&top_left_y=310&top_left_x=130)
$m = - \frac { 1 } { 2 }$
When two lines are perpendicular, then $m _ { 1 } \cdot m _ { 2 } = - 1$
Here $\mathrm { mBH } \times \mathrm { mAC } = - 1$
$\begin{gathered}
\left( \frac { \beta - 3 } { \alpha - 2 } \right) \left( \frac { 1 } { - 2 } \right) = - 1 \\
\beta - 3 = 2 \alpha - 4 \\
\beta = 2 \alpha - 1 \\
m _ { A H } \times m _ { B C } = - 1 \\
\Rightarrow \left( \frac { \beta - 2 } { \alpha - 1 } \right) ( - 2 ) = - 1 \\
\Rightarrow 2 \beta - 4 = \alpha - 1 \\
\Rightarrow 2 ( 2 \alpha - 1 ) = \alpha + 3 \\
\Rightarrow 3 \alpha = 5 \\
\alpha = \frac { 5 } { 3 } , \beta = \frac { 7 } { 3 } \Rightarrow H \left( \frac { 5 } { 3 } , \frac { 7 } { 3 } \right) \\
\alpha + 4 \beta = \frac { 5 } { 3 } + \frac { 28 } { 3 } = \frac { 33 } { 3 } = 11 \\
\beta + 4 \alpha = \frac { 7 } { 3 } + \frac { 20 } { 3 } = \frac { 27 } { 3 } = 9 \\
x ^ { 2 } - 20 x + 99 = 0
\end{gathered}$
7. (D)
![](https://cdn.mathpix.com/cropped/e9b73bf5-0740-4f61-9d85-6f61a0d7a615-04.jpg?height=533&width=867&top_left_y=260&top_left_x=173)

If $\cos 2 A + \cos 2 B + \cos 2 C$ is minimum then $\mathrm { A } = \mathrm { B } = \mathrm { C } = 60 ^ { \circ }$
So $\triangle \mathrm { ABC }$ is equilateral
8. (D)
Some content
9. (C)
Shortest distance between two lines
$\begin{aligned}
& \frac { x - x _ { 1 } } { a _ { 1 } } = \frac { y - y _ { 1 } } { a _ { 2 } } = \frac { z - z _ { 1 } } { a _ { 3 } } \\
& \frac { x - x _ { 2 } } { b _ { 1 } } = \frac { y - y _ { 2 } } { b _ { 2 } } = \frac { z - z _ { 2 } } { b _ { 3 } }
\end{aligned}$
is given as
$\begin{gathered}
\frac { \left| \begin{array} { c c c }
x _ { 1 } - x _ { 2 } & y _ { 1 } - y _ { 2 } & z _ { 1 } - z _ { 2 } \\
a _ { 1 } & a _ { 2 } & a _ { 3 } \\
b _ { 1 } & b _ { 2 } & b _ { 3 }
\end{array} \right| } { \sqrt { \left( a _ { 1 } b _ { 3 } - a _ { 3 } b _ { 2 } \right) ^ { 2 } + \left( a _ { 1 } b _ { 3 } - a _ { 3 } b _ { 1 } \right) ^ { 2 } + \left( a _ { 1 } b _ { 2 } - a _ { 2 } b _ { 1 } \right) ^ { 2 } } } \\
\frac { \left| \begin{array} { c c c }
5 - ( 3 ) & 2 - ( - 5 ) & 4 - 1 \\
1 & 2 & - 3 \\
1 & 4 & - 5
\end{array} \right| } { \sqrt { ( - 10 + 12 ) ^ { 2 } + ( - 5 + 3 ) ^ { 2 } + ( 4 - 2 ) ^ { 2 } } } \\
\frac { \left| \begin{array} { c c c }
8 & 7 & 3 \\
1 & 2 & - 3 \\
1 & 4 & - 5
\end{array} \right| } { \sqrt { ( 2 ) ^ { 2 } + ( 2 ) ^ { 2 } + ( 2 ) ^ { 2 } } } \\
= \frac { | 8 ( - 10 + 12 ) - 7 ( - 5 + 3 ) + 3 ( 4 - 2 ) | } { \sqrt { 4 + 4 + 4 } } \\
= \frac { 16 + 14 + 6 } { \sqrt { 12 } } = \frac { 36 } { \sqrt { 12 } } = \frac { 36 } { 2 \sqrt { 3 } } = \frac { 18 } { \sqrt { 3 } } = 6 \sqrt { 3 }
\end{gathered}$
10. (D)
Some content
11. (B)
Some content
12. (B)
Some content
13. (D)
$\begin{gathered}
\sqrt { ( x - 2 ) ^ { 2 } + y ^ { 2 } } = 2 \sqrt { ( x - 3 ) ^ { 2 } + y ^ { 2 } } \\
= x ^ { 2 } + y ^ { 2 } - 4 x + 4 = 4 x ^ { 2 } + 4 y ^ { 2 } - 24 x + 36 \\
= 3 x ^ { 2 } + 3 y ^ { 2 } - 20 x + 32 = 0 \\
= x ^ { 2 } + y ^ { 2 } - \frac { 20 } { 3 } x + \frac { 32 } { 3 } = 0 \\
= ( \alpha , \beta ) = \left( \frac { 10 } { 3 } , 0 \right) \\
\gamma = \sqrt { \frac { 100 } { 9 } - \frac { 32 } { 3 } } = \sqrt { \frac { 4 } { 9 } } = \frac { 2 } { 3 } \\
3 ( \alpha , \beta , \gamma ) = 3 \left( \frac { 10 } { 3 } + \frac { 2 } { 3 } \right) = 12
\end{gathered}$
14. (A)
Some content
15. (A)
Some content
16. (D)
Some content
17. (A)
Some content
18. (B)
Some content
19. (A)
Some content
20. (D)
Some content
21. (754.00)
Some content
22. (11.00)
![](https://cdn.mathpix.com/cropped/e9b73bf5-0740-4f61-9d85-6f61a0d7a615-12.jpg?height=611&width=743&top_left_y=269&top_left_x=164)
$A ( 2,6,2 ) B ( - 4,0 , \lambda ) , C ( 2,3 , - 1 ) D ( 4,5,0 )$
$\begin{gathered}
\text { Area } = \frac { 1 } { 2 } | \overrightarrow { B D } \times \overrightarrow { A C } | = 18 \\
\overrightarrow { A C } \times \overrightarrow { B D } = \left| \begin{array} { c c c }
\hat { i } & j & k \\
0 & - 3 & - 3 \\
8 & 5 & - \lambda
\end{array} \right| \\
= ( 3 \lambda + 15 ) \vec { i } - j ( - 24 ) + k ( - 24 )
\end{gathered}$
$\begin{gathered}
\overrightarrow { A C } \times \overrightarrow { B D } = ( 3 \lambda + 15 ) \hat { i } + 24 j - 24 k \\
= \sqrt { ( 3 \lambda + 15 ) ^ { 2 } + ( 24 ) ^ { 2 } + ( 24 ) ^ { 2 } } = 36 \\
= \lambda ^ { 2 } + 10 \lambda + 9 = 0 = \lambda = - 1 , - 9 \\
| \lambda | \leqslant 5 \Rightarrow \lambda = - 1 \\
5 - 6 \lambda = 5 - 6 ( - 1 ) = 11
\end{gathered}$
23. (514.00)
Some content
`;

function formatLatexBlocks(content) {
  const blockPattern = /\$\\begin\{(\w+)\}([\s\S]*?)\\end\{\1\}\$/g;
  return content.replace(blockPattern, (match, envName, innerContent) => {
    const formatted = innerContent
      .split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 0)
      .join(' ');
    return `$\\begin{${envName}} ${formatted} \\end{${envName}}$`;
  });
}

function extractVisualPaths(solutions, rawContent) {
  for (const solution of solutions) {
    const questionLabel = solution.question_label;
    if (!questionLabel) continue;

    const solutionStartPattern = new RegExp(
      `(?:^|\\n)\\s*${questionLabel}[\\s\\.\\)]+\\(?[A-Da-d0-9\\.]+\\)?`,
      'i'
    );

    const startMatch = rawContent.match(solutionStartPattern);
    if (!startMatch) {
      console.log(`[Q${questionLabel}] Could not find start pattern`);
      continue;
    }

    const startIndex = startMatch.index;

    const nextQuestionPattern = new RegExp(
      `\\n\\s*(${parseInt(questionLabel) + 1})\\s*[\\.\\)]`,
      'g'
    );
    nextQuestionPattern.lastIndex = startIndex + startMatch[0].length;

    let endIndex = rawContent.length;
    const nextMatch = nextQuestionPattern.exec(rawContent);
    if (nextMatch) {
      endIndex = nextMatch.index;
    }

    const solutionSection = rawContent.substring(startIndex, endIndex);

    // Check for image
    const imageMatch = solutionSection.match(/!\[[^\]]*\]\(([^)]+)\)/);

    if (imageMatch && imageMatch[1]) {
      // Has image - set visual_path
      if (!solution.visual_path) {
        solution.visual_path = imageMatch[1];
      }

      // Extract content after image - more reliable than LlamaParse for image solutions
      const imageLineEnd = solutionSection.indexOf(imageMatch[0]) + imageMatch[0].length;
      const contentAfterImage = solutionSection.substring(imageLineEnd).trim();

      if (contentAfterImage) {
        // Check if raw content has more math blocks than current worked_solution
        const currentWorkedSolution = solution.worked_solution || '';
        const rawMathBlocks = (contentAfterImage.match(/\$\\begin\{(gathered|aligned|array)\}/g) || []).length;
        const currentMathBlocks = (currentWorkedSolution.match(/\$\\begin\{(gathered|aligned|array)\}/g) || []).length;

        // Use raw content if it has more math blocks OR if current is empty/very short
        if (!currentWorkedSolution.trim() || currentWorkedSolution.length < 100 || rawMathBlocks > currentMathBlocks) {
          let cleanedContent = contentAfterImage
            .split('\n')
            .filter(line => !line.trim().startsWith('!['))
            .join('\n')
            .trim();

          solution.worked_solution = cleanedContent;
        }
      }
    } else {
      // No image - extract content directly
      const currentWorkedSolution = solution.worked_solution || '';

      // Skip lines that match the question header pattern (e.g., "13. (D)")
      const headerPattern = new RegExp(`^\\s*${questionLabel}[\\s\\.\\)]+\\(?[A-Da-d0-9\\.]+\\)?\\s*$`, 'i');
      const lines = solutionSection.split('\n');
      const contentLines = lines
        .filter(line => !headerPattern.test(line) && !line.trim().startsWith('![') && line.trim().length > 0)
        .join('\n')
        .trim();

      if (contentLines) {
        // Check if raw content has more math blocks than current worked_solution
        const rawMathBlocks = (contentLines.match(/\$\\begin\{(gathered|aligned|array)\}/g) || []).length;
        const currentMathBlocks = (currentWorkedSolution.match(/\$\\begin\{(gathered|aligned|array)\}/g) || []).length;

        // Use raw content if it has more math blocks OR if current is empty
        if (!currentWorkedSolution.trim() || rawMathBlocks > currentMathBlocks) {
          solution.worked_solution = contentLines;
        }
      }
    }
  }
  return solutions;
}

// Format LaTeX blocks for all solutions
function formatAllSolutionsLatex(solutions) {
  for (const solution of solutions) {
    if (solution.worked_solution) {
      solution.worked_solution = formatLatexBlocks(solution.worked_solution);
    }
  }
  return solutions;
}

// Test solutions - simulating partial/empty worked_solution from LlamaParse
const testSolutions = [
  { question_label: '6', answer_key: 'D', worked_solution: '', explanation: '' },
  { question_label: '9', answer_key: 'C', worked_solution: '', explanation: '' },
  { question_label: '13', answer_key: 'D', worked_solution: '', explanation: '' },
  { question_label: '22', answer_key: '11.00', worked_solution: '$A ( 2,6,2 ) B ( - 4,0 , \\lambda ) , C ( 2,3 , - 1 ) D ( 4,5,0 )$', explanation: '' }
];

// Run extraction and formatting
const extractedSolutions = extractVisualPaths(testSolutions, rawContent);
const result = formatAllSolutionsLatex(extractedSolutions);

console.log('='.repeat(70));
console.log('SOLUTION 6 - worked_solution (JSON):');
console.log('='.repeat(70));
console.log(JSON.stringify(result[0].worked_solution));

console.log('\n' + '='.repeat(70));
console.log('SOLUTION 9 - worked_solution (JSON):');
console.log('='.repeat(70));
console.log(JSON.stringify(result[1].worked_solution));

console.log('\n' + '='.repeat(70));
console.log('SOLUTION 13 - worked_solution (JSON):');
console.log('='.repeat(70));
console.log(JSON.stringify(result[2].worked_solution));

console.log('\n' + '='.repeat(70));
console.log('SOLUTION 22 - worked_solution (JSON):');
console.log('='.repeat(70));
console.log(JSON.stringify(result[3].worked_solution));
